version: '3.1'

services:

  createbuckets:
    image: quay.io/minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 minio minio123;
      /usr/bin/mc admin user add myminio minio_client minio_secret;
      /usr/bin/mc admin policy set myminio readwrite user=minio_client;
      /usr/bin/mc mb myminio/photos;
      /usr/bin/mc mb myminio/miniatures;
      /usr/bin/mc policy set public myminio/photos;
      /usr/bin/mc policy set public myminio/miniatures;
      exit 0;
      "

  migrate:
    build:
      context: .
      dockerfile: ./scripts/Dockerfile
    entrypoint: ["yarn", "rw", "prisma", "migrate", "deploy"]
    command: []
    depends_on:
      - db
    environment:
      DATABASE_URL: postgresql://${DATABASE_USER}:${DATABASE_PASSWORD}@db:5432/${DATABASE_DB}?connection_limit=1
